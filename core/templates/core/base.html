<!DOCTYPE html>

<html lang="en">
<head>
    {% block head %}{% endblock head %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"rel="stylesheet"/> 
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <title> {% block title %} Home {% endblock  %} </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <style>
    header .form-select:focus,
    header .form-control:focus {
        box-shadow: none !important;
    }
    header .btn:focus {
        box-shadow: none !important;
    }
    </style>
    {% block style %}
    
    {% endblock %}
    
</head>
<body>
    
    {% block content %}    {% endblock content %}
    <!-- Bootstrap JS Bundle (inclut Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    
    {% block script %}
        <script>
            const modal = document.getElementById("cart-modal");
            const overlay = document.getElementById("cart-overlay");
            const closeBtn = document.getElementById("close-cart-modal");

            function openCartModal(productHtml) {
            document.getElementById("cart-modal-product").innerHTML = productHtml;
            modal.classList.add("open");
            overlay.classList.add("open");
            }

            function closeCartModal() {
            modal.classList.remove("open");
            overlay.classList.remove("open");
            }

            closeBtn.addEventListener("click", closeCartModal);
            overlay.addEventListener("click", closeCartModal);

            // utility: get csrf token from cookie
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // close on ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeCartModal();
            });

            // Delegated handler for add-to-cart buttons (covers dynamic content)
            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.btn-add-cart');
                if (!btn) return;
                e.preventDefault();
                console.log('Add-to-cart clicked', btn);

                const productId = btn.dataset.productId;
                const quantity = btn.dataset.quantity || 1;

                // Basic validation
                if (!productId || isNaN(parseInt(productId))) {
                    console.warn('Invalid or missing product id:', productId);
                    openCartModal(`<div class="p-3">Produit non disponible pour ajout au panier.</div>`);
                    return;
                }

                const body = new URLSearchParams();
                body.append('product_id', productId);
                body.append('quantity', quantity);

                fetch('{% url "cart_add_ajax" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: body.toString()
                })
                .then(async res => {
                    const data = await res.json().catch(() => null);
                    if (!res.ok) {
                        console.error('Add to cart failed', res.status, data);
                        openCartModal(`<div class="p-3 text-danger">Erreur lors de l'ajout au panier (${res.status}).</div>`);
                        return;
                    }

                    if (!data) {
                        openCartModal(`<div class="p-3 text-danger">Réponse invalide du serveur.</div>`);
                        return;
                    }

                    if (data.success) {
                        openCartModal(`
                            <div class="d-flex gap-2 align-items-center">
                                <img src="${data.product.image}" width="80" alt="${data.product.name}">
                                <div>
                                    <p class="mb-0 fw-semibold">${data.product.name}</p>
                                    <p class="mb-0">${data.product.quantity} × ${data.product.price}</p>
                                </div>
                            </div>
                        `);

                        // update cart badge if present
                        const badge = document.querySelector('.cart-badge');
                        if (badge) badge.textContent = data.cart.total_items;
                    } else {
                        console.error('Cart add reported failure', data);
                        const msg = data.error || 'Erreur lors de l\'ajout au panier';
                        openCartModal(`<div class="p-3 text-danger">${msg}</div>`);
                    }
                })
                .catch(err => {
                    console.error('AJAX add cart error', err);
                    openCartModal(`<div class="p-3 text-danger">Erreur réseau lors de l'ajout au panier.</div>`);
                });
            });
        </script>
    {% endblock script %}
</body>
</html>