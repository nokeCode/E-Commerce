{% extends "core/base.html" %}

{% block title %} Order Payment {% endblock title %}

{% block head %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
</script>
{% endblock head %}

{% block style %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* Variables de couleurs cohérentes avec votre thème */
    :root {
        --cream-primary: #F7F3E9;
        --cream-dark: #E8E2D1;
        --cream-darker: #D4C9A8;
        --accent-brown: #A67C52;
        --accent-brown-dark: #8B5A3C;
        --accent-orange: #FF6B35;
        --text-dark: #5D4037;
        --text-light: #8D6E63;
        --cream-light: #FDFBF5;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        background-color: var(--cream-primary);
        color: var(--text-dark);
        line-height: 1.6;
        min-height: 100vh;
        padding: 20px;
    }

    .payment-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Header */
    .payment-header {
        background: var(--cream-light);
        border: 2px solid var(--cream-darker);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        text-align: center;
    }

    .payment-header h1 {
        color: var(--accent-brown);
        font-size: 2.2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }

    .payment-header p {
        color: var(--text-light);
        font-size: 1.1rem;
    }

    /* Layout principal */
    .payment-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    @media (max-width: 992px) {
        .payment-layout {
            grid-template-columns: 1fr;
        }
    }

    /* Colonnes */
    .column {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* Cartes */
    .payment-card {
        background: var(--cream-light);
        border: 2px solid var(--cream-darker);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.07);
    }

    .payment-card-header {
        background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-brown-dark) 100%);
        color: white;
        padding: 1.25rem 1.5rem;
        border-bottom: 3px solid var(--cream-darker);
    }

    .payment-card-header h2 {
        margin: 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 1.4rem;
    }

    .payment-card-body {
        padding: 1.5rem;
    }

    /* Formulaire */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .form-grid-double {
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-label {
        color: var(--text-dark);
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .required::after {
        content: '*';
        color: var(--danger-color);
        margin-left: 2px;
    }

    .form-input,
    .form-select {
        padding: 0.75rem 1rem;
        border: 2px solid var(--cream-darker);
        border-radius: 8px;
        font-size: 1rem;
        color: var(--text-dark);
        background-color: white;
        transition: all 0.3s ease;
        width: 100%;
    }

    .form-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%235D4037' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 12px;
    }

    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: var(--accent-brown);
        box-shadow: 0 0 0 3px rgba(166, 124, 82, 0.1);
    }

    /* Champs Stripe */
    .StripeElement {
        box-sizing: border-box;
        padding: 0.75rem 1rem;
        border: 2px solid var(--cream-darker);
        border-radius: 8px;
        background-color: white;
    }

    .StripeElement--focus {
        border-color: var(--accent-brown);
        box-shadow: 0 0 0 3px rgba(166, 124, 82, 0.1);
    }

    .StripeElement--invalid {
        border-color: var(--danger-color);
    }

    /* Récapitulatif */
    .summary-card {
        background: var(--cream-light);
        border: 2px solid var(--accent-brown);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(166, 124, 82, 0.15);
        margin-top: 1.5rem;
    }

    .summary-header {
        background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-brown-dark) 100%);
        color: white;
        padding: 1.25rem 1.5rem;
    }

    .summary-header h3 {
        margin: 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .summary-body {
        padding: 1.5rem;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--cream-dark);
    }

    .summary-item:last-child {
        border-bottom: none;
        padding-top: 1rem;
    }

    .summary-total {
        background: var(--cream-light);
        padding: 1.25rem;
        border-radius: 8px;
        margin-top: 1rem;
    }

    .total-label {
        color: var(--text-dark);
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
    }

    .total-amount {
        color: var(--accent-brown);
        font-weight: 800;
        font-size: 1.8rem;
    }

    /* Bouton de paiement */
    .payment-button-container {
        text-align: center;
        margin-top: 2rem;
    }

    .payment-button {
        background: linear-gradient(135deg, var(--accent-brown) 0%, var(--accent-brown-dark) 100%);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 1.25rem 3rem;
        font-weight: 700;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        box-shadow: 0 4px 15px rgba(166, 124, 82, 0.2);
        cursor: pointer;
        min-width: 300px;
    }

    .payment-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(166, 124, 82, 0.3);
        background: linear-gradient(135deg, var(--accent-brown-dark) 0%, var(--accent-brown) 100%);
    }

    .payment-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Modal succès */
    #order-success-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: var(--cream-light);
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        max-width: 400px;
        width: 90%;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .payment-header h1 {
            font-size: 1.8rem;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-grid-double {
            grid-template-columns: 1fr;
        }

        .payment-button {
            width: 100%;
            max-width: 300px;
            min-width: auto;
        }
    }

    /* Animation */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in {
        animation: fadeIn 0.5s ease forwards;
    }

    /* Messages d'erreur */
    .error-message {
        color: var(--danger-color);
        font-size: 0.9rem;
        margin-top: 0.5rem;
        display: none;
    }

    /* Overlay */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    /* Box */
    .modal-box {
        background: #fff;
        width: 100%;
        max-width: 420px;
        border-radius: 12px;
        padding: 2rem;
        position: relative;
        animation: scaleIn 0.3s ease;
    }

    /* Animation */
    @keyframes scaleIn {
        from {
            transform: scale(0.9);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Close button */
    .modal-close {
        position: absolute;
        top: 10px;
        right: 14px;
        background: none;
        border: none;
        font-size: 26px;
        cursor: pointer;
    }

    /* Title */
    .modal-title {
        text-align: center;
        margin-bottom: 1.5rem;
        color: #2d6a4f;
    }

    /* Content */
    .modal-content p {
        margin-bottom: 0.6rem;
    }

    /* Status */
    .status-success {
        color: #2ecc71;
        font-weight: bold;
    }

    /* Button */
    .modal-btn {
        display: block;
        margin-top: 1.5rem;
        text-align: center;
    }

    /* Options de paiement */
    .payment-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .payment-option {
        background: white;
        border: 2px solid var(--cream-dark);
        border-radius: 10px;
        padding: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .payment-option:hover {
        border-color: var(--accent-brown);
        box-shadow: 0 4px 12px rgba(166, 124, 82, 0.1);
    }

    .payment-option.selected {
        border-color: var(--accent-brown);
        background-color: rgba(166, 124, 82, 0.05);
    }

    .option-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.75rem;
    }

    .option-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .option-label h3 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-dark);
        margin: 0;
    }

    .custom-radio {
        width: 20px;
        height: 20px;
        border: 2px solid var(--cream-darker);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .custom-radio::after {
        content: '';
        width: 10px;
        height: 10px;
        background-color: var(--accent-brown);
        border-radius: 50%;
        display: none;
    }

    .payment-option.selected .custom-radio::after {
        display: block;
    }

    .payment-methods {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .payment-method {
        background: white;
        border: 1px solid var(--cream-darker);
        border-radius: 6px;
        padding: 0.4rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .payment-method:hover {
        border-color: var(--accent-brown);
    }

    .payment-method img {
        height: 20px;
        width: auto;
    }

    /* Champs carte bancaire */
    .card-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .input-with-icon {
        position: relative;
    }

    .card-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-light);
    }
</style>
{% endblock style %}

{% block content %}
{% include 'core/header.html' %}

<div class="payment-container">
    <!-- Header -->
    <header class="payment-header fade-in">
        <h1><i class="fas fa-lock"></i> Paiement sécurisé</h1>
        <p><i class="fas fa-shopping-cart me-1"></i> Finalisez votre commande</p>
    </header>

    <div class="payment-layout fade-in">
        <!-- ================= COLONNE GAUCHE ================= -->
        <div class="column">
            <!-- Adresse de livraison -->
            <div class="payment-card">
                <div class="payment-card-header">
                    <h2><i class="fas fa-truck"></i> Adresse de livraison</h2>
                </div>

                <div class="payment-card-body">
                    <form id="shipping-form">
                        {% csrf_token %}

                        <div class="form-group">
                            <label class="form-label required">Nom complet</label>
                            <input type="text" id="full-name" class="form-input" required>
                            <div class="error-message" id="name-error"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required" >Adresse</label>
                            <input type="text" id="address" class="form-input" required placeholder="Numéro, rue, appartement...">
                            <div class="error-message" id="address-error"></div>
                        </div>

                        <div class="form-grid form-grid-double">
                            <div class="form-group">
                                <label class="form-label required">Code postal</label>
                                <input type="text" id="postal-code" class="form-input" required>
                                <div class="error-message" id="postal-code-error"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">Ville</label>
                                <input type="text" id="city" class="form-input" required>
                                <div class="error-message" id="city-error"></div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label required">Pays</label>
                            <select id="country" class="form-select" required>
                                <option value="TG">Togo</option>
                                <option value="BJ">Bénin</option>
                                <option value="GH">Ghana</option>
                            </select>
                            <div class="error-message" id="country-error"></div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Récapitulatif -->
            <div class="summary-card">
                <div class="summary-header">
                    <h3><i class="fas fa-receipt"></i> Récapitulatif</h3>
                </div>

                <div class="summary-body">
                    <div class="summary-item">
                        <span>Sous-total</span>
                        <span>{{ cart_total }} €</span>
                    </div>

                    <div class="summary-total">
                        <div class="total-label">Total</div>
                        <div class="total-amount">{{ cart_total }} €</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= COLONNE DROITE ================= -->
        <div class="column">
            <!-- Paiement -->
            <div class="payment-card">
                <div class="payment-card-header">
                    <h2><i class="fas fa-credit-card"></i> Paiement</h2>
                </div>

                <!-- Options de paiement -->
                <div class="payment-options">
                    <!-- Carte de crédit -->
                    <div class="payment-option selected" id="credit-card-option">
                        <div class="option-header">
                            <div class="option-label">
                                <div class="custom-radio"></div>
                                <h3>Carte de crédit</h3>
                            </div>
                            <div class="payment-methods">
                                <div class="payment-method">
                                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@v5/icons/visa.svg" alt="Visa">
                                </div>
                                <div class="payment-method">
                                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@v5/icons/mastercard.svg"
                                        alt="Mastercard">
                                </div>
                                <div class="payment-method">
                                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@v5/icons/americanexpress.svg"
                                        alt="American Express">
                                </div>
                            </div>
                        </div>

                        <!-- Champs de carte de crédit -->
                        <div id="credit-card-fields">
                            <div id="card-element" class="StripeElement"></div>
                            <div class="error-message" id="card-errors"></div>
                        </div>
                    </div>

                    <!-- PayPal -->
                    <div class="payment-option" id="paypal-option">
                        <div class="option-header">
                            <div class="option-label">
                                <div class="custom-radio"></div>
                                <h3>PayPal</h3>
                            </div>
                            <div class="payment-methods">
                                <div class="payment-method">
                                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@v5/icons/paypal.svg"
                                        alt="PayPal" style="height: 18px;">
                                </div>
                            </div>
                            <div id="paypal-button-container"></div>

                            <script>
                                paypal.Buttons({
                                    createOrder: function (data, actions) {
                                        return actions.order.create({
                                            purchase_units: [{
                                                amount: {
                                                    value: "{{ cart_total }}"
                                                }
                                            }]
                                        });
                                    },

                                    onApprove: function (data, actions) {
                                        return actions.order.capture().then(function (details) {
                                            fetch("{% url 'payment_confirm_paypal' %}", {
                                                method: "POST",
                                                headers: {
                                                    "Content-Type": "application/json",
                                                    "X-CSRFToken": "{{ csrf_token }}"
                                                },
                                                body: JSON.stringify({
                                                    paypal_order_id: data.orderID
                                                })
                                            })
                                                .then(res => res.json())
                                                .then(data => {
                                                    if (data.success) {
                                                        window.location.href = "/orders/success/";
                                                    }
                                                });
                                        });
                                    }
                                }).render('#paypal-button-container');
                            </script>

                        </div>
                        <p style="color: var(--text-light); margin-top: 0.75rem; font-size: 0.9rem;">
                            Vous serez redirigé vers PayPal pour finaliser votre paiement.
                        </p>
                    </div>
                </div>

            </div>

            <!-- Bouton de paiement -->
            <div class="payment-button-container">
                <button id="pay-now-btn" class="payment-button">
                    <i class="fas fa-lock"></i> Payer maintenant
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ================= MODAL SUCCESS ================= -->
<div id="payment-modal" class="modal-overlay">
    <div class="modal-box">
        <button class="modal-close" id="close-modal">&times;</button>

        <h2 class="modal-title">
            <i class="fas fa-check-circle"></i>
            Paiement réussi
        </h2>

        <div class="modal-content">
            <p><strong>Nom :</strong> <span id="modal-name"></span></p>
            <p><strong>Méthode :</strong> Carte bancaire (Stripe)</p>
            <p><strong>Montant :</strong> <span id="modal-amount"></span> €</p>
            <p><strong>Statut :</strong> <span class="status-success">Payé</span></p>
        </div>

        <a href="/" class="payment-button modal-btn">
            Retour à la boutique
        </a>
    </div>
</div>


{% include 'core/footer.html' %}
{% endblock content %}

{% block script %}
<script src="https://js.stripe.com/clover/stripe.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialisation Stripe
        const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
        const elements = stripe.elements();
        const card = elements.create('card');
        card.mount('#card-element');

        const payBtn = document.getElementById('pay-now-btn');
        const shippingForm = document.getElementById('shipping-form');
        const errorMessages = document.querySelectorAll('.error-message');

        // Afficher les messages d'erreur
        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // Masquer tous les messages d'erreur
        function hideAllErrors() {
            errorMessages.forEach(error => {
                error.style.display = 'none';
            });
        }

        // Validation du formulaire
        function validateForm() {
            hideAllErrors();

            const fullName = document.getElementById('full-name').value.trim();
            const address = document.getElementById('address').value.trim();
            const postalCode = document.getElementById('postal-code').value.trim();
            const city = document.getElementById('city').value.trim();
            const country = document.getElementById('country').value;
            let isValid = true;

            if (!fullName) {
                showError('name-error', 'Veuillez entrer votre nom complet');
                isValid = false;
            }

            if (!address) {
                showError('address-error', 'Veuillez entrer votre adresse');
                isValid = false;
            }

            if (!postalCode) {
                showError('postal-code-error', 'Veuillez entrer votre code postal');
                isValid = false;
            }

            if (!city) {
                showError('city-error', 'Veuillez entrer votre ville');
                isValid = false;
            }

            if (!country) {
                showError('country-error', 'Veuillez sélectionner votre pays');
                isValid = false;
            }

            return isValid;
        }

        // Gestion du paiement
        payBtn.addEventListener('click', async function () {
            // Validation du formulaire
            if (!validateForm()) {
                return;
            }

            // Désactiver le bouton
            payBtn.disabled = true;
            payBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement en cours...';

            try {
                // Créer l'intention de paiement
                const response = await fetch("{% url 'create_payment_intent' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        full_name: document.getElementById("full-name").value,
                        address: document.getElementById("address").value,
                        city: document.getElementById("city").value,
                        postal_code: document.getElementById("postal-code").value,
                        country: document.getElementById("country").value
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de la création du paiement');
                }

                // Confirmer le paiement
                const result = await stripe.confirmCardPayment(
                    data.client_secret,
                    {
                        payment_method: {
                            card: card,
                            billing_details: {
                                name: document.getElementById("full-name").value,
                                address: {
                                    line1: document.getElementById("address").value,
                                    city: document.getElementById("city").value,
                                    postal_code: document.getElementById("postal-code").value,
                                    country: document.getElementById("country").value
                                }
                            }
                        }
                    }
                );

                if (result.error) {
                    // Afficher l'erreur de carte
                    showError('card-errors', result.error.message);
                    payBtn.disabled = false;
                    payBtn.innerHTML = '<i class="fas fa-lock"></i> Payer maintenant';
                } else {
                    // Succès - afficher le modal
                    const modal = document.getElementById("payment-modal");

                    document.getElementById("modal-name").textContent =
                        document.getElementById("full-name").value;

                    document.getElementById("modal-amount").textContent =
                        "{{ cart_total }}";

                    modal.style.display = "flex";
                    document.getElementById("close-modal").addEventListener("click", function () {
                        document.getElementById("payment-modal").style.display = "none";
                    });
                    document.getElementById("payment-modal").addEventListener("click", function (e) {
                        if (e.target === this) {
                            this.style.display = "none";
                        }
                    });

                    // Envoyer les détails du paiement au backend
                    const confirmResponse = await fetch("{% url 'payment_confirm' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({
                            payment_intent: result.paymentIntent.id,
                            full_name: document.getElementById("full-name").value,
                            address: document.getElementById("address").value,
                            city: document.getElementById("city").value,
                            postal_code: document.getElementById("postal-code").value,
                            country: document.getElementById("country").value
                        })
                    });

                    if (!confirmResponse.ok) {
                        const confirmError = await confirmResponse.json();
                        showError('card-errors', confirmError.error || 'Erreur lors de la sauvegarde de la commande');
                        payBtn.disabled = false;
                        payBtn.innerHTML = '<i class="fas fa-lock"></i> Payer maintenant';
                        modal.style.display = "none";
                    }
                }




            } catch (error) {
                console.error('Erreur:', error);
                showError('card-errors', 'Une erreur est survenue. Veuillez réessayer.');
                payBtn.disabled = false;
                payBtn.innerHTML = '<i class="fas fa-lock"></i> Payer maintenant';
            }
        });

        // Masquer les erreurs lors de la saisie
        const inputs = document.querySelectorAll('.form-input, .form-select');
        inputs.forEach(input => {
            input.addEventListener('input', function () {
                const errorId = this.id + '-error';
                const errorElement = document.getElementById(errorId);
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
            });
        });

        // Gestion des erreurs de carte en temps réel
        card.addEventListener('change', function (event) {
            const errorElement = document.getElementById('card-errors');
            if (event.error) {
                errorElement.textContent = event.error.message;
                errorElement.style.display = 'block';
            } else {
                errorElement.style.display = 'none';
            }
        });
    });
</script>
{% endblock script %}