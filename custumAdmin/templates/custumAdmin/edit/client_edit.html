{% extends "custumAdmin/base_admin.html" %}
{% block title %}Modifier {{ client.get_full_name|default:client.username }} - phénix{% endblock %}
{% load static %}

{% block extra_css %}
<style>
    /* ========== MÊME STYLE QUE LA PAGE D'AJOUT ========== */
    :root {
        --primary-brown: #A67C52;
        --primary-dark: #8B5A3C;
        --cream-bg: #F7F3E9;
        --cream-light: #FDFBF5;
        --cream-border: #D4C9A8;
        --text-dark: #5D4037;
        --text-muted: #8D6E63;
    }

    .page-header {
        margin-bottom: 2rem;
    }

    .btn-back {
        background: white;
        border: 2px solid var(--cream-border);
        border-radius: 30px;
        padding: 0.6rem 1.2rem;
        color: var(--text-dark);
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-right: 1rem;
    }

    .btn-back:hover {
        border-color: var(--primary-brown);
        background: var(--cream-light);
        color: var(--primary-dark);
        transform: translateX(-3px);
    }

    .btn-header-group {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .btn-cancel {
        background: white;
        border: 2px solid var(--cream-border);
        border-radius: 30px;
        padding: 0.75rem 1.5rem;
        color: var(--text-dark);
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-cancel:hover {
        border-color: var(--primary-brown);
        background: var(--cream-light);
        color: var(--primary-dark);
        transform: translateY(-2px);
    }

    .btn-update {
        background: var(--primary-brown);
        border: none;
        border-radius: 30px;
        padding: 0.75rem 2rem;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(166, 124, 82, 0.2);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-update:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(166, 124, 82, 0.3);
    }

    .form-card {
        background: white;
        border: 2px solid var(--cream-border);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 8px 20px rgba(166, 124, 82, 0.05);
    }

    .form-card h5 {
        color: var(--text-dark);
        font-weight: 700;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .form-card h5 i {
        color: var(--primary-brown);
    }

    .form-label {
        color: var(--text-dark);
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-control, .form-select {
        border: 2px solid var(--cream-border);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        color: var(--text-dark);
        transition: all 0.3s ease;
        width: 100%;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-brown);
        box-shadow: 0 0 0 0.25rem rgba(166, 124, 82, 0.15);
        outline: none;
    }

    .form-control:disabled {
        background: var(--cream-light);
        opacity: 0.7;
    }

    /* ========== AVATAR ========== */
    .avatar-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 1rem;
    }

    .current-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary-brown);
        margin-bottom: 1rem;
    }

    .avatar-initial {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: var(--cream-light);
        color: var(--primary-brown);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: 700;
        border: 3px solid var(--primary-brown);
        margin-bottom: 1rem;
    }

    .photo-upload {
        width: 100%;
    }

    .form-check-input {
        width: 18px;
        height: 18px;
        border: 2px solid var(--cream-border);
        border-radius: 4px;
        cursor: pointer;
        accent-color: var(--primary-brown);
        margin-right: 0.5rem;
    }

    .info-text {
        background: var(--cream-light);
        border-radius: 8px;
        padding: 0.5rem 1rem;
        color: var(--text-muted);
        font-size: 0.9rem;
    }

    @media (max-width: 768px) {
        .btn-header-group {
            flex-direction: column;
            width: 100%;
        }
        
        .btn-cancel, .btn-update {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- EN-TÊTE AVEC RETOUR -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 page-header">
        <div class="d-flex align-items-center">
            <a href="{% url 'client_list' %}" class="btn-back">
                <i class="fa-solid fa-arrow-left"></i> Retour
            </a>
            <div>
                <h2 class="fw-bold mb-1">Modifier le client</h2>
                <p class="text-muted mb-0">ID: {{ client.id }} • Membre depuis {{ client.date_joined|date:"d/m/Y" }}</p>
            </div>
        </div>
        <div class="btn-header-group">
            <a href="{% url 'client_detail' client.id %}" class="btn-cancel">
                <i class="fa-solid fa-xmark"></i> Annuler
            </a>
            <button type="submit" form="clientForm" class="btn-update">
                <i class="fa-solid fa-floppy-disk"></i> Sauvegarder
            </button>
        </div>
    </div>

    <!-- FORMULAIRE -->
    <form id="clientForm" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="row g-4">
            <!-- COLONNE GAUCHE (8 colonnes) -->
            <div class="col-lg-8">
                <!-- INFORMATIONS DE BASE -->
                <div class="form-card">
                    <h5>
                        <i class="fa-solid fa-user"></i>
                        Informations de base
                    </h5>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nom d'utilisateur</label>
                            <input type="text" name="username" class="form-control" 
                                   value="{{ client.username }}" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" 
                                   value="{{ client.email }}" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Prénom</label>
                            <input type="text" name="first_name" class="form-control" 
                                   value="{{ client.first_name|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Nom</label>
                            <input type="text" name="last_name" class="form-control" 
                                   value="{{ client.last_name|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Téléphone</label>
                            <input type="tel" name="phone" class="form-control" 
                                   value="{{ client.phone|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Genre</label>
                            <select name="gender" class="form-select">
                                <option value="">Non spécifié</option>
                                <option value="M" {% if client.gender == 'M' %}selected{% endif %}>Masculin</option>
                                <option value="F" {% if client.gender == 'F' %}selected{% endif %}>Féminin</option>
                                <option value="O" {% if client.gender == 'O' %}selected{% endif %}>Autre</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Date de naissance</label>
                            <input type="date" name="birth_date" class="form-control" 
                                   value="{{ client.birth_date|date:'Y-m-d'|default:'' }}">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Nouveau mot de passe</label>
                            <input type="password" name="password" class="form-control" placeholder="••••••••">
                            <small class="text-muted">Laissez vide pour ne pas changer</small>
                        </div>
                    </div>
                </div>

                <!-- ADRESSE -->
                <div class="form-card">
                    <h5>
                        <i class="fa-solid fa-location-dot"></i>
                        Adresse
                    </h5>

                    <div class="mb-3">
                        <label class="form-label">Adresse</label>
                        <textarea name="address" class="form-control" rows="2">{{ profile.address|default:'' }}</textarea>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Ville</label>
                            <input type="text" name="city" class="form-control" value="{{ profile.city|default:'' }}">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Code postal</label>
                            <input type="text" name="postal_code" class="form-control" value="{{ profile.postal_code|default:'' }}">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Pays</label>
                            <input type="text" name="country" class="form-control" value="{{ profile.country|default:'' }}">
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLONNE DROITE (4 colonnes) -->
            <div class="col-lg-4">
                <!-- PHOTO DE PROFIL -->
                <div class="form-card">
                    <h5>
                        <i class="fa-solid fa-camera"></i>
                        Photo de profil
                    </h5>

                    <div class="avatar-container">
                        {% if profile.photo %}
                            <img src="{{ profile.photo.url }}" class="current-avatar" id="currentAvatar">
                        {% else %}
                            <div class="avatar-initial" id="avatarInitial">
                                {{ client.first_name|first|upper }}{{ client.last_name|first|upper }}
                            </div>
                        {% endif %}

                        <div class="photo-upload">
                            <label class="form-label">Changer la photo</label>
                            <input type="file" name="photo" class="form-control" accept="image/*" id="photoInput">
                            <small class="text-muted">Formats: JPG, PNG (max 2 Mo)</small>
                        </div>

                        {% if profile.photo %}
                            <div class="form-check mt-3">
                                <input type="checkbox" class="form-check-input" name="remove_photo" id="removePhoto">
                                <label class="form-check-label" for="removePhoto">Supprimer la photo actuelle</label>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- STATUT & OPTIONS -->
                <div class="form-card">
                    <h5>
                        <i class="fa-solid fa-gear"></i>
                        Statut & Options
                    </h5>

                    <div class="mb-3">
                        <label class="form-label">Statut du compte</label>
                        <div class="d-flex align-items-center gap-3">
                            <div class="form-check">
                                <input type="radio" class="form-check-input" name="is_active" id="activeYes" 
                                       value="true" {% if client.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="activeYes">Actif</label>
                            </div>
                            <div class="form-check">
                                <input type="radio" class="form-check-input" name="is_active" id="activeNo" 
                                       value="false" {% if not client.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="activeNo">Inactif</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="newsletter" id="newsletter"
                               {% if client.newsletter_subscribed %}checked{% endif %}>
                        <label class="form-check-label" for="newsletter">
                            Abonné à la newsletter
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="is_vip" id="isVip"
                               {% if client.is_vip %}checked{% endif %}>
                        <label class="form-check-label" for="isVip">
                            <i class="fa-solid fa-crown me-1" style="color: var(--primary-brown);"></i>
                            Client VIP
                        </label>
                    </div>

                    <div class="info-text">
                        <i class="fa-solid fa-calendar me-1"></i> Inscrit le {{ client.date_joined|date:"d/m/Y" }}
                    </div>
                </div>

                <!-- NOTES -->
                <div class="form-card">
                    <h5>
                        <i class="fa-solid fa-note-sticky"></i>
                        Notes internes
                    </h5>
                    <textarea name="notes" class="form-control" rows="4">{{ profile.notes|default:'' }}</textarea>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Prévisualisation de la nouvelle photo
        const photoInput = document.getElementById('photoInput');
        const currentAvatar = document.getElementById('currentAvatar');
        const avatarInitial = document.getElementById('avatarInitial');

        if (photoInput) {
            photoInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        if (currentAvatar) {
                            currentAvatar.src = e.target.result;
                        } else if (avatarInitial) {
                            // Remplacer l'initial par une image
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'current-avatar';
                            img.id = 'currentAvatar';
                            avatarInitial.parentNode.replaceChild(img, avatarInitial);
                        }
                    };
                    reader.readAsDataURL(this.files[0]);
                }
            });
        }

        // Gestionnaire pour "supprimer la photo"
        const removePhotoCheck = document.getElementById('removePhoto');
        if (removePhotoCheck) {
            removePhotoCheck.addEventListener('change', function() {
                if (this.checked) {
                    photoInput.disabled = true;
                } else {
                    photoInput.disabled = false;
                }
            });
        }
    });
</script>
{% endblock %}